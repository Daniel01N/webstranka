<!-- File: views/zakazky.html -->
<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Zak√°zky ‚Äì ElektroSpr√°va</title>
  <link rel="stylesheet" href="styles.css">

  <style>
    /* specifick√© styly pro str√°nku Zak√°zky */
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    .form-section,
    .table-section {
      background: var(--clr-surface);
      padding: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--clr-border);
      border-radius: 4px;
    }
    .materials-list { margin: 1rem 0; }
    .material-line {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .material-line select,
    .material-line input {
      flex: 1;
    }
    .material-line button {
      background: transparent;
      border: none;
      color: var(--clr-accent);
      font-size: 1.3rem;
      cursor: pointer;
    }
    .material-line button:hover {
      color: var(--clr-primary);
    }
  </style>
</head>
<body>
  <header>
    <span class="icon">‚ö°</span> ElektroSpr√°va ‚Äì Zak√°zky
    <nav><a href="/">Dom≈Ø</a></nav>
  </header>

  <main class="container">
    <!-- Formul√°≈ô pro novou zak√°zku -->
    <section class="form-section">
      <h2>Vytvo≈ôit novou zak√°zku</h2>
      <form action="/pridat-zakazku" method="POST">
        <label for="zakaznik">Z√°kazn√≠k</label>
        <select id="zakaznik" name="zakaznik_id" required>
          <option value="">Naƒç√≠t√°m‚Ä¶</option>
        </select>

        <label for="datum">Datum zak√°zky</label>
        <input id="datum" name="datum" type="date" required>

        <div id="materialsContainer" class="materials-list"></div>
        <button type="button" onclick="addLine()">‚ûï P≈ôidat materi√°l</button>

        <label for="totalPrice">Celkem (Kƒç)</label>
        <input id="totalPrice" name="celkova_cena" readonly>

        <button type="submit">‚úÖ Potvrdit zak√°zku</button>
      </form>
    </section>

    <!-- Tabulka existuj√≠c√≠ch zak√°zek -->
    <section class="table-section">
      <h2>Seznam zak√°zek</h2>
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Z√°kazn√≠k</th>
            <th>Datum</th>
            <th>Celkem Kƒç</th>
            <th>Materi√°ly</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody id="zakazkyBody">
          <tr><td colspan="6" style="text-align:center">Naƒç√≠t√°m‚Ä¶</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <script>
    let materials = [];

    // Naƒçten√≠ dat: z√°kazn√≠ci, materi√°ly, zak√°zky
    Promise.all([
      fetch('/api/zakaznici').then(r=>r.json()),
      fetch('/api/materialy').then(r=>r.json()),
      fetch('/api/zakazky').then(r=>r.json())
    ]).then(([custs, mats, orders]) => {
      materials = mats;
      initCustomerSelect(custs);
      renderOrders(orders);
    });

    // napln√≠ <select> z√°kazn√≠k≈Ø
    function initCustomerSelect(custs) {
      const sel = document.querySelector('select[name=zakaznik_id]');
      sel.innerHTML = '<option value="">Vyber z√°kazn√≠ka</option>';
      custs.forEach(c => {
        const o = document.createElement('option');
        o.value = c.id;
        o.textContent = c.jmeno;
        sel.appendChild(o);
      });
    }

    // p≈ôid√° ≈ô√°dek v√Ωbƒõru materi√°lu + mno≈æstv√≠
    function addLine() {
      const cont = document.getElementById('materialsContainer');
      const div  = document.createElement('div');
      div.className = 'material-line';

      const sel = document.createElement('select');
      sel.name = 'material_id';
      materials.forEach(m => {
        const o = document.createElement('option');
        o.value = m.id;
        o.textContent = `${m.nazev} (${m.cena_za_jednotku} Kƒç/${m.jednotka})`;
        sel.appendChild(o);
      });
      sel.onchange = recalc;
      div.appendChild(sel);

      const inp = document.createElement('input');
      inp.name = 'mnozstvi';
      inp.type = 'number';
      inp.min = 1;
      inp.value = 1;
      inp.oninput = recalc;
      div.appendChild(inp);

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'üóëÔ∏è';
      btn.onclick = () => { div.remove(); recalc(); };
      div.appendChild(btn);

      cont.appendChild(div);
      recalc();
    }

    // p≈ôepoƒç√≠t√° celkovou cenu
    function recalc() {
      let sum = 0;
      document.querySelectorAll('.material-line').forEach(div => {
        const sel = div.querySelector('select');
        const inp = div.querySelector('input');
        const mat = materials.find(m => m.id == sel.value);
        const qty = parseFloat(inp.value);
        if (mat && qty) sum += mat.cena_za_jednotku * qty;
      });
      document.getElementById('totalPrice').value = sum.toFixed(2);
    }

    // vykresl√≠ seznam zak√°zek do tabulky
    function renderOrders(orders) {
      const tbody = document.getElementById('zakazkyBody');
      tbody.innerHTML = '';
      if (orders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">≈Ω√°dn√© zak√°zky</td></tr>';
        return;
      }
      orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.jmeno}</td>
          <td>${o.datum}</td>
          <td>${o.celkova_cena}</td>
          <td>${o.materialy || '‚Äì'}</td>
          <td>
            <form action="/smazat-zakazku" method="POST" style="display:inline">
              <input type="hidden" name="id" value="${o.id}">
              <button class="btn-delete">üóëÔ∏è</button>
            </form>
          </td>`;
        tbody.appendChild(tr);
      });
    }
  </script>
</body>
</html>
